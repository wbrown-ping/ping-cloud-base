{
    "name": "Kube Proxy Error in Logs",
    "type": "monitor",
    "monitor_type": "bucket_level_monitor",
    "enabled": true,
    "schedule": {
        "period": {
            "unit": "MINUTES",
            "interval": 1
        }
    },
    "inputs": [
        {
            "search": {
                "indices": [
                    "kube-proxy-*"
                ],
                "query": {
                    "size": 0,
                    "query": {
                        "bool": {
                            "must": [
                                {
                                    "match_phrase": {
                                        "log_message": "err=<"
                                    }
                                }
                            ]
                        }
                    },
                    "aggregations": {
                        "composite_agg": {
                            "composite": {
                                "sources": [
                                    {
                                        "cluster_name": {
                                            "terms": {
                                                "field": "cluster_name.keyword"
                                            }
                                        }
                                    }
                                ]
                            }
                        }
                    }
                }
            }
        }
    ],
    "triggers": [
        {
            "bucket_level_trigger": {
                "id": "trigger_1",
                "name": "Error Count Trigger",
                "severity": "1",
                "condition": {
                    "buckets_path": {
                        "_count": "_count"
                    },
                    "parent_bucket_path": "composite_agg",
                    "script": {
                        "source": "params._count > 0",
                        "lang": "painless"
                    },
                    "gap_policy": "skip"
                },
                "actions": [
                    {
                        "id": "action_1",
                        "name": "Send Alert",
                        "destination_id": "sns_alerts",
                        "message_template": {
                            "source": "{\n  \"alert\": \"{{ctx.monitor.name}}\",\n  \"documents\": {{ctx.results.0.hits.total.value}},\n  \"cluster\": \"{{#ctx.newAlerts}}{{bucket_keys}}{{/ctx.newAlerts}}{{#ctx.dedupedAlerts}}{{bucket_keys}}{{/ctx.dedupedAlerts}}\",\n  \"timestamp\": \"{{ctx.periodEnd}}\",\n  \"runbook\": \"\"\n}",
                            "lang": "mustache"
                        },
                        "throttle_enabled": false,
                        "subject_template": {
                            "source": "ALERT: {{ctx.monitor.name}}",
                            "lang": "mustache"
                        },
                        "action_execution_policy": {
                            "action_execution_scope": {
                                "per_alert": {
                                    "actionable_alerts": [
                                        "NEW"
                                    ]
                                }
                            }
                        }
                    }
                ]
            }
        }
    ]
}